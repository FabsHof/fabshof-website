name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Get current version
        id: current_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Determine version bump
        id: bump
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # Regex pattern for conventional commits with optional scope
          # Format: type(optional-scope)?: description
          # Scope can contain letters, numbers, #, -, _

          # Check for breaking change (major bump)
          # Matches: type!, type(scope)!, or BREAKING CHANGE: anywhere
          if echo "$COMMIT_MSG" | grep -qiE "^[a-z]+(\([a-zA-Z0-9#_-]+\))?!:|BREAKING CHANGE:"; then
            echo "bump=major" >> $GITHUB_OUTPUT
            echo "Detected: BREAKING CHANGE -> major bump"
          # Check for feature (minor bump)
          # Matches: feat:, feat(scope):, feat(#21):, etc.
          elif echo "$COMMIT_MSG" | grep -qiE "^feat(\([a-zA-Z0-9#_-]+\))?:"; then
            echo "bump=minor" >> $GITHUB_OUTPUT
            echo "Detected: feat -> minor bump"
          # Check for fix, perf, refactor, etc. (patch bump)
          # Matches: fix:, fix(scope):, chore(#21):, etc.
          elif echo "$COMMIT_MSG" | grep -qiE "^(fix|perf|refactor|build|ci|docs|style|test|chore)(\([a-zA-Z0-9#_-]+\))?:"; then
            echo "bump=patch" >> $GITHUB_OUTPUT
            echo "Detected: fix/perf/refactor/etc -> patch bump"
          else
            echo "bump=none" >> $GITHUB_OUTPUT
            echo "No conventional commit prefix detected -> no version bump"
          fi

      - name: Calculate new version
        id: new_version
        if: steps.bump.outputs.bump != 'none'
        run: |
          CURRENT="${{ steps.current_version.outputs.version }}"
          BUMP="${{ steps.bump.outputs.bump }}"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "$BUMP" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version bump: $CURRENT -> $NEW_VERSION"

      - name: Update package.json version
        if: steps.bump.outputs.bump != 'none'
        run: |
          npm version ${{ steps.new_version.outputs.new_version }} --no-git-tag-version

      - name: Commit version bump
        if: steps.bump.outputs.bump != 'none'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ steps.new_version.outputs.new_version }}"
          git push

      - name: Create and push tag
        if: steps.bump.outputs.bump != 'none'
        run: |
          git tag "v${{ steps.new_version.outputs.new_version }}"
          git push origin "v${{ steps.new_version.outputs.new_version }}"

      - name: Create GitHub Release
        if: steps.bump.outputs.bump != 'none'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.new_version.outputs.new_version }}
          name: Release v${{ steps.new_version.outputs.new_version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
